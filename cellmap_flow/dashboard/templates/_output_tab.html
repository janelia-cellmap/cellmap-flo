<!-- output_postprocess.html -->
<h3>Post-Processing</h3>
<form id="postProcessForm">
  {% for normalizer in output_postprocessors %}
    <div class="form-check mb-2">
      <input
        class="form-check-input postProcessCheckbox"
        type="checkbox"
        id="postProcessMethod_{{ normalizer.name }}"
        name="postProcessMethod_{{ normalizer.name }}"
        value="{{ normalizer.name }}"
      />
      <label
        class="form-check-label"
        for="postProcessMethod_{{ normalizer.name }}"
      >
        {{ normalizer.name }}
      </label>
    </div>

    <div
      id="postProcess_{{ normalizer.name }}Params"
      class="ps-4"
      style="display: none;"
    >
      {% for param_name, default_val in normalizer.params.items() %}
        <div class="mb-3">
          <label
            for="postProcess_{{ normalizer.name }}_{{ param_name }}"
            class="form-label"
          >
            {{ param_name }}
          </label>
          <input
            type="text"
            class="form-control"
            id="postProcess_{{ normalizer.name }}_{{ param_name }}"
            name="postProcess_{{ normalizer.name }}_{{ param_name }}"
            value="{{ default_val }}"
          />
        </div>
      {% endfor %}
    </div>
    <hr />
  {% endfor %}

  <!-- Custom Code -->
  <div class="form-check mb-2">
    <input
      class="form-check-input"
      type="checkbox"
      value="custom_code"
      id="customCodeCheckbox_postProcess"
    />
    <label
      class="form-check-label"
      for="customCodeCheckbox_postProcess"
    >
      Custom Code (PostProcess)
    </label>
  </div>

  <div
    id="customCodeParams_postProcess"
    style="display: none; margin-left: 20px;"
  >
    <h3>Python Code Editor (PostProcess)</h3>
    <textarea
      id="pythonEditor_postProcess"
      class="form-control"
      rows="5"
      placeholder="Enter Python code here..."
    ></textarea>
    <div id="errorMsg_postProcess" class="text-danger mt-2"></div>
  </div>

  <!-- Same "Submit All" button ID as in input_norm.html -->
  <button type="button" class="btn btn-primary mt-3" id="submitAll">
    Submit All
  </button>

  <div class="mt-3">
    <textarea
      id="submissionLog_postProcess"
      class="form-control"
      rows="5"
      readonly
      style="color: gray; font-size: x-small; background-color: transparent; border: 1px solid gray;"
    ></textarea>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Show/hide param fields for post-process checkboxes
  const postProcessCheckboxes = document.querySelectorAll(
    "#postProcessForm .postProcessCheckbox"
  );
  postProcessCheckboxes.forEach((checkbox) => {
    checkbox.addEventListener("change", function () {
      const paramDiv = document.getElementById(
        "postProcess_" + this.value + "Params"
      );
      if (paramDiv) {
        paramDiv.style.display = this.checked ? "block" : "none";
      }
    });
  });

  // Toggle custom code
  const customCodeCheckbox = document.getElementById(
    "customCodeCheckbox_postProcess"
  );
  const customCodeParams = document.getElementById(
    "customCodeParams_postProcess"
  );
  customCodeCheckbox.addEventListener("change", function () {
    customCodeParams.style.display = this.checked ? "block" : "none";
  });

  // Optional: Skulpt-based syntax checking
  const editor = document.getElementById("pythonEditor_postProcess");
  const errorMsg = document.getElementById("errorMsg_postProcess");
  const logArea = document.getElementById("submissionLog_postProcess");

  function checkSyntax() {
    if (typeof Sk === "undefined") {
      return;
    }
    try {
      Sk.parse("user_code.py", editor.value);
      errorMsg.textContent = "";
    } catch (err) {
      errorMsg.textContent = err.toString();
    }
  }

  function debounce(func, delay) {
    let timeout;
    return function () {
      clearTimeout(timeout);
      timeout = setTimeout(func, delay);
    };
  }
  editor.addEventListener("input", debounce(checkSyntax, 500));

  // Helper function to gather "postprocess" data
  window.gatherPostProcessData = function () {
    const payload = {};
    postProcessCheckboxes.forEach((cb) => {
      if (cb.checked && cb !== customCodeCheckbox) {
        const baseName = cb.value;
        payload[baseName] = {};

        const paramDiv = document.getElementById(
          "postProcess_" + baseName + "Params"
        );
        const inputs = paramDiv.querySelectorAll("input");
        inputs.forEach((inp) => {
          const paramName = inp.id.replace(
            "postProcess_" + baseName + "_",
            ""
          );
          payload[baseName][paramName] = inp.value;
        });
      }
    });
    // If custom code is checked
    if (customCodeCheckbox.checked) {
      payload.custom_code = editor.value;
    }
    return payload;
  };
});
</script>
