<!-- input_norm.html -->
<h3>Input Normalization Methods</h3>
<form id="inputNormForm">
  {% for normalizer in input_normalizers %}
    <div class="form-check mb-2">
      <input
        class="form-check-input inputNormCheckbox"
        type="checkbox"
        id="inputNormMethod_{{ normalizer.name }}"
        name="inputNormMethod_{{ normalizer.name }}"
        value="{{ normalizer.name }}"
      />
      <label
        class="form-check-label"
        for="inputNormMethod_{{ normalizer.name }}"
      >
        {{ normalizer.name }}
      </label>
    </div>

    <div
      id="inputNorm_{{ normalizer.name }}Params"
      class="ps-4"
      style="display: none;"
    >
      {% for param_name, default_val in normalizer.params.items() %}
        <div class="mb-3">
          <label
            for="inputNorm_{{ normalizer.name }}_{{ param_name }}"
            class="form-label"
          >
            {{ param_name }}
          </label>
          <input
            type="text"
            class="form-control"
            id="inputNorm_{{ normalizer.name }}_{{ param_name }}"
            name="inputNorm_{{ normalizer.name }}_{{ param_name }}"
            value="{{ default_val }}"
          />
        </div>
      {% endfor %}
    </div>
    <hr />
  {% endfor %}

  <!-- Custom Code for Input Norm -->
  <div class="form-check mb-2">
    <input
      class="form-check-input"
      type="checkbox"
      value="custom_code"
      id="customCodeCheckbox_inputNorm"
    />
    <label
      class="form-check-label"
      for="customCodeCheckbox_inputNorm"
    >
      Custom Code (Input Norm)
    </label>
  </div>

  <div
    id="customCodeParams_inputNorm"
    style="display: none; margin-left: 20px;"
  >
    <h3>Python Code Editor (Input Norm)</h3>
    <textarea
      id="pythonEditor_inputNorm"
      class="form-control"
      rows="5"
      placeholder="Enter Python code here..."
    ></textarea>
    <div id="errorMsg_inputNorm" class="text-danger mt-2"></div>
  </div>

  <!-- Same "Submit All" button ID as in postprocess partial -->
  <button type="button" class="btn btn-primary mt-3" id="submitAll">
    Submit All
  </button>

  <div class="mt-3">
    <textarea
      id="submissionLog_inputNorm"
      class="form-control"
      rows="5"
      readonly
      style="color: gray; font-size: x-small; background-color: transparent; border: 1px solid gray;"
    ></textarea>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Show/hide parameter fields for input norm
  const normalizerCheckboxes = document.querySelectorAll(
    "#inputNormForm .inputNormCheckbox"
  );
  normalizerCheckboxes.forEach((checkbox) => {
    checkbox.addEventListener("change", function () {
      const paramDiv = document.getElementById(
        "inputNorm_" + this.value + "Params"
      );
      if (paramDiv) {
        paramDiv.style.display = this.checked ? "block" : "none";
      }
    });
  });

  // Toggle custom code
  const customCodeCheckbox = document.getElementById(
    "customCodeCheckbox_inputNorm"
  );
  const customCodeParams = document.getElementById("customCodeParams_inputNorm");
  customCodeCheckbox.addEventListener("change", function () {
    customCodeParams.style.display = this.checked ? "block" : "none";
  });

  // Optional: Skulpt-based live syntax checking for input norm
  const editor = document.getElementById("pythonEditor_inputNorm");
  const errorMsg = document.getElementById("errorMsg_inputNorm");
  const logArea = document.getElementById("submissionLog_inputNorm");

  // If you want to keep the real-time syntax checking:
  function checkSyntax() {
    if (typeof Sk === "undefined") {
      return; // If Skulpt isn't loaded, skip
    }
    try {
      Sk.parse("user_code.py", editor.value);
      errorMsg.textContent = "";
    } catch (err) {
      errorMsg.textContent = err.toString();
    }
  }

  function debounce(func, delay) {
    let timeout;
    return function () {
      clearTimeout(timeout);
      timeout = setTimeout(func, delay);
    };
  }
  editor.addEventListener("input", debounce(checkSyntax, 500));

  // Helper function to gather "input_norm" data
  window.gatherInputNormData = function () {
    const payload = {};
    normalizerCheckboxes.forEach((cb) => {
      if (cb.checked && cb !== customCodeCheckbox) {
        const baseName = cb.value;
        payload[baseName] = {};

        const paramDiv = document.getElementById(
          "inputNorm_" + baseName + "Params"
        );
        const inputs = paramDiv.querySelectorAll("input");
        inputs.forEach((inp) => {
          const paramName = inp.id.replace(
            "inputNorm_" + baseName + "_",
            ""
          );
          payload[baseName][paramName] = inp.value;
        });
      }
    });
    // If custom code is checked
    if (customCodeCheckbox.checked) {
      payload.custom_code = editor.value;
    }
    return payload;
  };
});
</script>
